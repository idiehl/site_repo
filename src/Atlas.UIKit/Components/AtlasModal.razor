@namespace Atlas.UIKit.Components
@using Microsoft.AspNetCore.Components.Web

@if (IsOpen)
{
    <div class="atlas-modal-overlay @(IsOpen ? "atlas-modal-overlay--open" : "")"
         @onclick="HandleBackdropClick"
         @onkeydown="HandleKeyDown">
        <div class="atlas-modal @SizeClass"
             role="dialog"
             aria-modal="true"
             aria-labelledby="@_titleId"
             tabindex="-1"
             @onclick:stopPropagation="true">
            <div class="atlas-modal__header">
                @if (!string.IsNullOrWhiteSpace(Title))
                {
                    <h2 class="atlas-modal__title" id="@_titleId">@Title</h2>
                }
                <button class="atlas-modal__close" type="button" @onclick="Close" aria-label="Close dialog">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                        <path d="M2 2L14 14M14 2L2 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="atlas-modal__body">
                @ChildContent
            </div>
            @if (FooterContent is not null)
            {
                <div class="atlas-modal__footer">
                    @FooterContent
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public string Size { get; set; } = "md";
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? FooterContent { get; set; }
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private readonly string _titleId = $"atlas-modal-title-{Guid.NewGuid():N}"[..28];

    private string SizeClass => Size switch
    {
        "sm" => "atlas-modal--sm",
        "lg" => "atlas-modal--lg",
        _ => "atlas-modal--md"
    };

    private async Task Close()
    {
        await IsOpenChanged.InvokeAsync(false);
    }

    private async Task HandleBackdropClick()
    {
        await Close();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await Close();
        }
    }
}
